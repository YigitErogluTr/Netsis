
SELECT
    s.STHAR_TARIH AS FATURA_TARIH,
    s.FISNO AS FATURA_NO,    
    s.STHAR_CARIKOD AS CARI_KOD,
    c.CARI_ISIM AS CARI_TANIM,     
    s.STOK_KODU AS STOK_KODU,
    st.STOK_ADI AS STOK_ADI,
    st.OLCU_BR1 AS BIRIM,  
    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN 'SATIS'
        WHEN s.STHAR_GCKOD = 'G' THEN 'SATIS IADE'
    END AS HAREKET_TIPI,

    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN s.STHAR_GCMIK 
        WHEN s.STHAR_GCKOD = 'G' THEN -s.STHAR_GCMIK 
    END AS MIKTAR,
    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN (s.STHAR_GCMIK * s.STHAR_NF)
        WHEN s.STHAR_GCKOD = 'G' THEN -(s.STHAR_GCMIK * s.STHAR_NF)
    END AS TOPLAM_TRY
FROM OTS2026.dbo.TBLSTHAR s
LEFT JOIN OTS2026.dbo.TBLSTSABIT st ON s.STOK_KODU = st.STOK_KODU
LEFT JOIN OTS2026.dbo.TBLCASABIT c ON s.STHAR_CARIKOD = c.CARI_KOD
WHERE s.STHAR_HTUR = 'J'           
  AND s.STHAR_GCKOD IN ('C','G')    
ORDER BY s.STHAR_TARIH
