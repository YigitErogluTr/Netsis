---* FIs Bazında Satış -İade  *
SELECT
    s.STHAR_TARIH AS FATURA_TARIH,
    s.FISNO AS FATURA_NO,    
    s.STHAR_CARIKOD AS CARI_KOD,
    c.CARI_ISIM AS CARI_TANIM,     
    s.STOK_KODU AS STOK_KODU,
    st.STOK_ADI AS STOK_ADI,
    st.OLCU_BR1 AS BIRIM,  
    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN 'SATIS'
        WHEN s.STHAR_GCKOD = 'G' THEN 'SATIS IADE'
    END AS HAREKET_TIPI,

    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN s.STHAR_GCMIK 
        WHEN s.STHAR_GCKOD = 'G' THEN -s.STHAR_GCMIK 
    END AS MIKTAR,
    CASE 
        WHEN s.STHAR_GCKOD = 'C' THEN (s.STHAR_GCMIK * s.STHAR_NF)
        WHEN s.STHAR_GCKOD = 'G' THEN -(s.STHAR_GCMIK * s.STHAR_NF)
    END AS TOPLAM_TRY
FROM OTS2026.dbo.TBLSTHAR s
LEFT JOIN OTS2026.dbo.TBLSTSABIT st ON s.STOK_KODU = st.STOK_KODU
LEFT JOIN OTS2026.dbo.TBLCASABIT c ON s.STHAR_CARIKOD = c.CARI_KOD
WHERE s.STHAR_HTUR = 'J'           
  AND s.STHAR_GCKOD IN ('C','G')    
ORDER BY s.STHAR_TARIH

--*Fıs Bazında Detaylı Satış  *

SELECT *,A.SEHIR AS SEHIR_UST,A.BOLGE AS BOLGE_UST,A.KOD2 AS KOD2_UST,A.CARI_KOD AS CARI_UST FROM (
SELECT 
TBLSTHAR.FISNO,
 CASE WHEN TBLCASABIT.GRUP_KODU = '' THEN 'BOS' 
 WHEN TBLCASABIT.GRUP_KODU IS NULL THEN 'BOS' 
 ELSE TBLCASABIT.GRUP_KODU END AS SEHIR, 
CASE WHEN TBLCASABIT.RAPOR_KODU1 = '' THEN 'BOS' 
 WHEN TBLCASABIT.RAPOR_KODU1 IS NULL THEN 'BOS' 
 ELSE TBLCASABIT.RAPOR_KODU1 END 
 AS BOLGE,
 CASE WHEN TBLCASABIT.RAPOR_KODU2 = '' THEN 'BOS' 
 WHEN TBLCASABIT.RAPOR_KODU2 IS NULL THEN 'BOS' 
 ELSE TBLCASABIT.RAPOR_KODU2 END 
 AS KOD2,
TBLCASABIT.CARI_KOD, 
TBLCASABIT.CARI_ISIM COLLATE SQL_EBCDIC297_CP1_CS_AS AS CARI_ISIM, 
TBLSTHAR.STHAR_TARIH,
MONTH(TBLSTHAR.STHAR_TARIH) AS AY_NO,
CASE MONTH(TBLSTHAR.STHAR_TARIH) 
WHEN 1 THEN 'OCAK' 
WHEN 2 THEN 'SUBAT'
WHEN 3 THEN 'MART'
WHEN 4 THEN 'NISAN' 
WHEN 5 THEN 'MAYIS'
WHEN 6 THEN 'HAZIRAN'
WHEN 7 THEN 'TEMMUZ' 
WHEN 8 THEN 'AGUSTOS'
WHEN 9 THEN 'EYLUL'
WHEN 10 THEN 'EKIM' 
WHEN 11 THEN 'KASIM'
WHEN 12 THEN 'ARALIK'
END
AS AY,
CASE TBLSTHAR.STHAR_DOVTIP WHEN 0 THEN 'TL'
						   WHEN 1 THEN 'USD'
						   WHEN 2 THEN 'EURO'
						   END DOVIZ_TIPI,
TBLSTHAR.STHAR_NF * TBLSTHAR.STHAR_GCMIK TL_SATIS_TUTAR,
CASE TBLSTHAR.STHAR_DOVTIP WHEN 1 THEN TBLSTHAR.STHAR_DOVFIAT * TBLSTHAR.STHAR_GCMIK ELSE 0 END USD_SATIS_TUTAR,
CASE TBLSTHAR.STHAR_DOVTIP WHEN 2 THEN TBLSTHAR.STHAR_DOVFIAT * TBLSTHAR.STHAR_GCMIK ELSE 0 END EURO_SATIS_TUTAR,
TBLSTHAR.STOK_KODU,ST.STOK_ADI,TBLSTHAR.STHAR_GCMIK MIKTAR,TBLSTHAR.STHAR_NF BIRIMFIYAT
FROM TBLSTHAR WITH(NOLOCK)INNER JOIN
     TBLCASABIT WITH(NOLOCK)ON TBLSTHAR.STHAR_ACIKLAMA = TBLCASABIT.CARI_KOD  INNER JOIN
     TBLFATUIRS WITH(NOLOCK)ON TBLSTHAR.FISNO = TBLFATUIRS.FATIRS_NO AND 
							TBLSTHAR.STHAR_ACIKLAMA = TBLFATUIRS.CARI_KODU AND 
							TBLSTHAR.STHAR_FTIRSIP = TBLFATUIRS.FTIRSIP
							INNER JOIN TBLSTSABIT ST WITH (NOLOCK) ON ST.STOK_KODU=TBLSTHAR.STOK_KODU
                     

WHERE   TBLSTHAR.STHAR_FTIRSIP = '1' AND TBLFATUIRS.TIPI=2 AND TBLCASABIT.CARI_TIP <> 'S'
--GROUP BY TBLCASABIT.GRUP_KODU, TBLCASABIT.RAPOR_KODU1,TBLCASABIT.RAPOR_KODU2,TBLCASABIT.CARI_KOD,TBLCASABIT.CARI_ISIM,TBLSTHAR.STHAR_TARIH,TBLSTHAR.STHAR_DOVTIP
--,TBLSTHAR.STOK_KODU, ST.STOK_ADI
)A


-- * Müşteri&Kalem Bazında Toplam Satış *

SELECT 
    A.CARI_KOD, 
    A.CARI_ISIM, 
    A.STOK_KODU, 
    A.STOK_ADI, 
    A.SEHIR AS SEHIR_UST, 
    A.BOLGE AS BOLGE_UST, 
    SUM(A.MIKTAR) AS TOPLAM_MIKTAR,
    SUM(A.TL_SATIS_TUTAR) AS TOPLAM_TL_TUTAR,
    SUM(A.USD_SATIS_TUTAR) AS TOPLAM_USD_TUTAR,
    SUM(A.EURO_SATIS_TUTAR) AS TOPLAM_EURO_TUTAR
FROM (
    SELECT 
        CASE WHEN TBLCASABIT.GRUP_KODU IN ('', NULL) THEN 'BOS' ELSE TBLCASABIT.GRUP_KODU END AS SEHIR, 
        CASE WHEN TBLCASABIT.RAPOR_KODU1 IN ('', NULL) THEN 'BOS' ELSE TBLCASABIT.RAPOR_KODU1 END AS BOLGE,
        CASE WHEN TBLCASABIT.RAPOR_KODU2 IN ('', NULL) THEN 'BOS' ELSE TBLCASABIT.RAPOR_KODU2 END AS KOD2,
        TBLCASABIT.CARI_KOD, 
        TBLCASABIT.CARI_ISIM COLLATE SQL_EBCDIC297_CP1_CS_AS AS CARI_ISIM, 
        TBLSTHAR.STOK_KODU,
        ST.STOK_ADI,
        TBLSTHAR.STHAR_GCMIK AS MIKTAR,
        (TBLSTHAR.STHAR_NF * TBLSTHAR.STHAR_GCMIK) AS TL_SATIS_TUTAR,
        CASE TBLSTHAR.STHAR_DOVTIP WHEN 1 THEN TBLSTHAR.STHAR_DOVFIAT * TBLSTHAR.STHAR_GCMIK ELSE 0 END AS USD_SATIS_TUTAR,
        CASE TBLSTHAR.STHAR_DOVTIP WHEN 2 THEN TBLSTHAR.STHAR_DOVFIAT * TBLSTHAR.STHAR_GCMIK ELSE 0 END AS EURO_SATIS_TUTAR
    FROM TBLSTHAR WITH(NOLOCK)
    INNER JOIN TBLCASABIT WITH(NOLOCK) ON TBLSTHAR.STHAR_ACIKLAMA = TBLCASABIT.CARI_KOD 
    INNER JOIN TBLFATUIRS WITH(NOLOCK) ON TBLSTHAR.FISNO = TBLFATUIRS.FATIRS_NO 
        AND TBLSTHAR.STHAR_ACIKLAMA = TBLFATUIRS.CARI_KODU 
        AND TBLSTHAR.STHAR_FTIRSIP = TBLFATUIRS.FTIRSIP
    INNER JOIN TBLSTSABIT ST WITH (NOLOCK) ON ST.STOK_KODU = TBLSTHAR.STOK_KODU
    WHERE TBLSTHAR.STHAR_FTIRSIP = '1' 
      AND TBLFATUIRS.TIPI = 2 
      AND TBLCASABIT.CARI_TIP <> 'S'
) AS A
GROUP BY 
    A.CARI_KOD, 
    A.CARI_ISIM, 
    A.STOK_KODU, 
    A.STOK_ADI, 
    A.SEHIR, 
    A.BOLGE
ORDER BY 
    A.CARI_ISIM, 
    A.STOK_ADI;
